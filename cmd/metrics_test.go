package cmd_test

import (
	"fmt"
	"math"
	"os/exec"
	"testing"

	"github.com/google/go-cmp/cmp"
	"github.com/organicveggie/psychic-tribble/cmd"
	"github.com/organicveggie/psychic-tribble/testutils"
)

const (
	testUnitName    = "restic-backup.service"
	invocationIdOut = "4775db08699a457696d94410100482bc"
	journalLogsOut  = `
	{"_SELINUX_CONTEXT":"unconfined\n","_SYSTEMD_UNIT":"restic-backup.service","_COMM":"restic-forget.s","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","SYSLOG_IDENTIFIER":"restic-forget.sh","__REALTIME_TIMESTAMP":"1635433299390861","SYSLOG_FACILITY":"3","_PID":"948999","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","__MONOTONIC_TIMESTAMP":"316992983328","_EXE":"/usr/bin/bash","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SYSTEMD_SLICE":"system.slice","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","MESSAGE":"Removing old restic snaphots for Z97X-UD5H","_GID":"0","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db2;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce411120;t=5cf6afcdd318d;x=2afbe19139bd63fb","_HOSTNAME":"Z97X-UD5H","_UID":"0","_TRANSPORT":"stdout","_CMDLINE":"/bin/bash /usr/local/sbin/restic-forget.sh"}
	{"_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","__REALTIME_TIMESTAMP":"1635433299397170","_PID":"949012","SYSLOG_IDENTIFIER":"restic-forget.sh","SYSLOG_FACILITY":"3","PRIORITY":"6","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_CAP_EFFECTIVE":"3bfffeffff","_GID":"0","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_SLICE":"system.slice","_HOSTNAME":"Z97X-UD5H","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db3;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce4129c4;t=5cf6afcdd4a32;x=67f471aaa72c42a3","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SELINUX_CONTEXT":"unconfined\n","__MONOTONIC_TIMESTAMP":"316992989636","_SYSTEMD_UNIT":"restic-backup.service","_TRANSPORT":"stdout","_EXE":"/usr/bin/restic","_CMDLINE":"restic check","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_COMM":"restic","MESSAGE":"using temporary cache in /tmp/restic-check-cache-717982783","_UID":"0"}
	{"_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_PID":"949012","SYSLOG_FACILITY":"3","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_UID":"0","MESSAGE":"create exclusive lock for repository","_HOSTNAME":"Z97X-UD5H","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db4;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce4a55f2;t=5cf6afce6765f;x=ad9b625e6a81ff7c","SYSLOG_IDENTIFIER":"restic-forget.sh","_SYSTEMD_SLICE":"system.slice","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","PRIORITY":"6","_TRANSPORT":"stdout","__MONOTONIC_TIMESTAMP":"316993590770","_COMM":"restic","_CMDLINE":"restic check","_GID":"0","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_CAP_EFFECTIVE":"3bfffeffff","_EXE":"/usr/bin/restic","__REALTIME_TIMESTAMP":"1635433299998303","_SELINUX_CONTEXT":"unconfined\n","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SYSTEMD_UNIT":"restic-backup.service"}
	{"_SYSTEMD_SLICE":"system.slice","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_PID":"949012","SYSLOG_FACILITY":"3","_COMM":"restic","_UID":"0","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_TRANSPORT":"stdout","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_GID":"0","__MONOTONIC_TIMESTAMP":"316993871070","_EXE":"/usr/bin/restic","SYSLOG_IDENTIFIER":"restic-forget.sh","_CAP_EFFECTIVE":"3bfffeffff","_SELINUX_CONTEXT":"unconfined\n","_SYSTEMD_UNIT":"restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db5;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce4e9cde;t=5cf6afceabd4c;x=ced9cac54c6fe26a","_HOSTNAME":"Z97X-UD5H","PRIORITY":"6","_CMDLINE":"restic check","MESSAGE":"load indexes","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","__REALTIME_TIMESTAMP":"1635433300278604","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07"}
	{"_UID":"0","PRIORITY":"6","MESSAGE":"check all packs","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SYSTEMD_SLICE":"system.slice","__REALTIME_TIMESTAMP":"1635433300698645","_GID":"0","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_HOSTNAME":"Z97X-UD5H","_TRANSPORT":"stdout","SYSLOG_IDENTIFIER":"restic-forget.sh","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SELINUX_CONTEXT":"unconfined\n","__MONOTONIC_TIMESTAMP":"316994291111","_SYSTEMD_UNIT":"restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db6;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce5505a7;t=5cf6afcf12615;x=c396c0d30ddc5bd","_CMDLINE":"restic check","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_PID":"949012","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_COMM":"restic","_EXE":"/usr/bin/restic","SYSLOG_FACILITY":"3","_CAP_EFFECTIVE":"3bfffeffff"}
	{"_UID":"0","_SELINUX_CONTEXT":"unconfined\n","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db7;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce558c21;t=5cf6afcf1ac8f;x=9022ec3cb6a1285","__REALTIME_TIMESTAMP":"1635433300733071","_PID":"949012","_EXE":"/usr/bin/restic","_CMDLINE":"restic check","_SYSTEMD_SLICE":"system.slice","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_TRANSPORT":"stdout","SYSLOG_FACILITY":"3","_HOSTNAME":"Z97X-UD5H","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_COMM":"restic","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_GID":"0","SYSLOG_IDENTIFIER":"restic-forget.sh","__MONOTONIC_TIMESTAMP":"316994325537","_SYSTEMD_UNIT":"restic-backup.service","MESSAGE":"check snapshots, trees and blobs"}
	{"__REALTIME_TIMESTAMP":"1635433301778521","_PID":"949012","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_HOSTNAME":"Z97X-UD5H","MESSAGE":"no errors were found","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_TRANSPORT":"stdout","_CMDLINE":"restic check","SYSLOG_FACILITY":"3","_SYSTEMD_SLICE":"system.slice","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","PRIORITY":"6","__MONOTONIC_TIMESTAMP":"316995370987","_SELINUX_CONTEXT":"unconfined\n","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SYSTEMD_UNIT":"restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db8;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce657feb;t=5cf6afd01a059;x=bc9939b0e2cd8432","_UID":"0","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_GID":"0","_COMM":"restic","SYSLOG_IDENTIFIER":"restic-forget.sh","_EXE":"/usr/bin/restic","_CAP_EFFECTIVE":"3bfffeffff"}
	{"_COMM":"restic","_CMDLINE":"restic check","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","SYSLOG_IDENTIFIER":"restic-forget.sh","_PID":"949012","_SELINUX_CONTEXT":"unconfined\n","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4db9;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce657feb;t=5cf6afd01a059;x=7d4144e079481226","SYSLOG_FACILITY":"3","_TRANSPORT":"stdout","_CAP_EFFECTIVE":"3bfffeffff","MESSAGE":"[0:01] 100.00%  30 / 30 snapshots","_EXE":"/usr/bin/restic","__REALTIME_TIMESTAMP":"1635433301778521","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","__MONOTONIC_TIMESTAMP":"316995370987","_UID":"0","_GID":"0","_SYSTEMD_SLICE":"system.slice","PRIORITY":"6","_HOSTNAME":"Z97X-UD5H","_SYSTEMD_UNIT":"restic-backup.service"}
	{"_EXE":"/usr/bin/restic","_HOSTNAME":"Z97X-UD5H","SYSLOG_IDENTIFIER":"restic-forget.sh","_SYSTEMD_UNIT":"restic-backup.service","_SYSTEMD_SLICE":"system.slice","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dba;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce72f5dd;t=5cf6afd0f164b;x=490f348323a0f76b","_CAP_EFFECTIVE":"3bfffeffff","__MONOTONIC_TIMESTAMP":"316996253149","_GID":"0","PRIORITY":"6","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_COMM":"restic","_UID":"0","_PID":"949037","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","__REALTIME_TIMESTAMP":"1635433302660683","_SELINUX_CONTEXT":"unconfined\n","_TRANSPORT":"stdout","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_CMDLINE":"restic forget --keep-hourly 24 --keep-daily 7 --keep-weekly 4 --keep-monthly 6 --host Z97X-UD5H --json","SYSLOG_FACILITY":"3","MESSAGE":null}
	{"_PID":"949050","_UID":"0","_TRANSPORT":"stdout","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","SYSLOG_FACILITY":"3","_HOSTNAME":"Z97X-UD5H","SYSLOG_IDENTIFIER":"restic-forget.sh","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_UNIT":"restic-backup.service","_SYSTEMD_SLICE":"system.slice","__REALTIME_TIMESTAMP":"1635433302685014","_EXE":"/usr/bin/restic","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dbb;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce7354e9;t=5cf6afd0f7556;x=69fcd05aba02b124","_CAP_EFFECTIVE":"3bfffeffff","_GID":"0","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_CMDLINE":"restic check","_SELINUX_CONTEXT":"unconfined\n","MESSAGE":"using temporary cache in /tmp/restic-check-cache-256729198","__MONOTONIC_TIMESTAMP":"316996277481","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_COMM":"restic","PRIORITY":"6"}
	{"_SYSTEMD_UNIT":"restic-backup.service","_PID":"949050","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_CAP_EFFECTIVE":"3bfffeffff","_TRANSPORT":"stdout","SYSLOG_IDENTIFIER":"restic-forget.sh","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_COMM":"restic","_EXE":"/usr/bin/restic","PRIORITY":"6","__REALTIME_TIMESTAMP":"1635433303260933","_SYSTEMD_SLICE":"system.slice","__MONOTONIC_TIMESTAMP":"316996853400","_HOSTNAME":"Z97X-UD5H","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dbc;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce7c1e98;t=5cf6afd183f05;x=48a4bdd58ff30977","MESSAGE":"create exclusive lock for repository","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_CMDLINE":"restic check","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SELINUX_CONTEXT":"unconfined\n","_GID":"0","_UID":"0","SYSLOG_FACILITY":"3","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc"}
	{"__MONOTONIC_TIMESTAMP":"316997110571","_TRANSPORT":"stdout","_PID":"949050","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_SYSTEMD_SLICE":"system.slice","__REALTIME_TIMESTAMP":"1635433303518104","MESSAGE":"load indexes","_UID":"0","_GID":"0","_EXE":"/usr/bin/restic","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_COMM":"restic","_HOSTNAME":"Z97X-UD5H","SYSLOG_FACILITY":"3","_SYSTEMD_UNIT":"restic-backup.service","SYSLOG_IDENTIFIER":"restic-forget.sh","_CAP_EFFECTIVE":"3bfffeffff","_CMDLINE":"restic check","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dbd;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce800b2b;t=5cf6afd1c2b98;x=2be6154ea91d1461","PRIORITY":"6","_SELINUX_CONTEXT":"unconfined\n"}
	{"_COMM":"restic","_SYSTEMD_UNIT":"restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dbe;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce85cf23;t=5cf6afd21ef90;x=e906b386d5af33b6","_GID":"0","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","PRIORITY":"6","_UID":"0","SYSLOG_IDENTIFIER":"restic-forget.sh","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_PID":"949050","__MONOTONIC_TIMESTAMP":"316997488419","_EXE":"/usr/bin/restic","_SYSTEMD_SLICE":"system.slice","_CMDLINE":"restic check","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_HOSTNAME":"Z97X-UD5H","_TRANSPORT":"stdout","MESSAGE":"check all packs","_CAP_EFFECTIVE":"3bfffeffff","SYSLOG_FACILITY":"3","__REALTIME_TIMESTAMP":"1635433303895952","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SELINUX_CONTEXT":"unconfined\n","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec"}
	{"__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dbf;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce864d1b;t=5cf6afd226d89;x=ec3df1482e18e48e","_UID":"0","_COMM":"restic","_PID":"949050","_GID":"0","__MONOTONIC_TIMESTAMP":"316997520667","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_CAP_EFFECTIVE":"3bfffeffff","SYSLOG_FACILITY":"3","MESSAGE":"check snapshots, trees and blobs","_SELINUX_CONTEXT":"unconfined\n","PRIORITY":"6","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","__REALTIME_TIMESTAMP":"1635433303928201","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_TRANSPORT":"stdout","SYSLOG_IDENTIFIER":"restic-forget.sh","_EXE":"/usr/bin/restic","_CMDLINE":"restic check","_SYSTEMD_SLICE":"system.slice","_SYSTEMD_UNIT":"restic-backup.service","_HOSTNAME":"Z97X-UD5H","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07"}
	{"_GID":"0","_SYSTEMD_SLICE":"system.slice","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SELINUX_CONTEXT":"unconfined\n","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_TRANSPORT":"stdout","SYSLOG_FACILITY":"3","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc0;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce968247;t=5cf6afd32a2b5;x=3a4fb21f91fe0f8e","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","__MONOTONIC_TIMESTAMP":"316998582855","_CAP_EFFECTIVE":"3bfffeffff","_COMM":"restic","PRIORITY":"6","MESSAGE":"[0:01] 100.00%  29 / 29 snapshots","SYSLOG_IDENTIFIER":"restic-forget.sh","__REALTIME_TIMESTAMP":"1635433304990389","_UID":"0","_EXE":"/usr/bin/restic","_CMDLINE":"restic check","_SYSTEMD_UNIT":"restic-backup.service","_PID":"949050","_HOSTNAME":"Z97X-UD5H"}
	{"__REALTIME_TIMESTAMP":"1635433304990389","_UID":"0","SYSLOG_IDENTIFIER":"restic-forget.sh","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_SYSTEMD_UNIT":"restic-backup.service","MESSAGE":"no errors were found","PRIORITY":"6","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","SYSLOG_FACILITY":"3","__MONOTONIC_TIMESTAMP":"316998582855","_CMDLINE":"restic check","_PID":"949050","_CAP_EFFECTIVE":"3bfffeffff","_HOSTNAME":"Z97X-UD5H","_SELINUX_CONTEXT":"unconfined\n","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_EXE":"/usr/bin/restic","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc1;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce968247;t=5cf6afd32a2b5;x=59a6e63b07bf7239","_COMM":"restic","_TRANSPORT":"stdout","_GID":"0","_SYSTEMD_SLICE":"system.slice"}
	{"__MONOTONIC_TIMESTAMP":"316998600379","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SELINUX_CONTEXT":"unconfined\n","_STREAM_ID":"655c47214a7b49698a67904d17ed2b07","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","PRIORITY":"6","_TRANSPORT":"stdout","_GID":"0","MESSAGE":"Finished restic snapshot removal","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_UID":"0","SYSLOG_FACILITY":"3","_SYSTEMD_SLICE":"system.slice","_PID":"948999","_COMM":"restic-forget.s","_CAP_EFFECTIVE":"3bfffeffff","__REALTIME_TIMESTAMP":"1635433305007913","_SYSTEMD_UNIT":"restic-backup.service","_CMDLINE":"/bin/bash /usr/local/sbin/restic-forget.sh","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc2;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce96c6bb;t=5cf6afd32e729;x=6fc1c885915bf439","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_HOSTNAME":"Z97X-UD5H","_EXE":"/usr/bin/bash","SYSLOG_IDENTIFIER":"restic-forget.sh"}
	{"__MONOTONIC_TIMESTAMP":"316998624206","_COMM":"restic-backup.s","_TRANSPORT":"stdout","_PID":"949064","_EXE":"/usr/bin/bash","_SYSTEMD_UNIT":"restic-backup.service","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_CAP_EFFECTIVE":"3bfffeffff","PRIORITY":"6","_UID":"0","SYSLOG_FACILITY":"3","_CMDLINE":"/bin/bash /usr/local/sbin/restic-backup.sh","_SELINUX_CONTEXT":"unconfined\n","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc3;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce9723ce;t=5cf6afd33443c;x=4bc17d3c941667c3","SYSLOG_IDENTIFIER":"restic-backup.sh","__REALTIME_TIMESTAMP":"1635433305031740","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_GID":"0","MESSAGE":"Starting restic backup","_SYSTEMD_SLICE":"system.slice","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_HOSTNAME":"Z97X-UD5H","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service"}
	{"__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc4;b=9d572844f08843b2988fe83d5dfea7ec;m=49ce973945;t=5cf6afd3359b3;x=b2fd5bf8cc85220","__REALTIME_TIMESTAMP":"1635433305037235","_TRANSPORT":"stdout","_SYSTEMD_SLICE":"system.slice","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_GID":"0","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_EXE":"/usr/bin/restic","SYSLOG_IDENTIFIER":"restic-backup.sh","_SYSTEMD_UNIT":"restic-backup.service","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_COMM":"restic","_CMDLINE":"restic check","_SELINUX_CONTEXT":"unconfined\n","_PID":"949065","MESSAGE":"using temporary cache in /tmp/restic-check-cache-299105240","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_UID":"0","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","SYSLOG_FACILITY":"3","_HOSTNAME":"Z97X-UD5H","__MONOTONIC_TIMESTAMP":"316998629701","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff"}
	{"_CAP_EFFECTIVE":"3bfffeffff","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc5;b=9d572844f08843b2988fe83d5dfea7ec;m=49cea00975;t=5cf6afd3c29e3;x=4430f96849618f7d","_COMM":"restic","_UID":"0","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","PRIORITY":"6","SYSLOG_IDENTIFIER":"restic-backup.sh","__REALTIME_TIMESTAMP":"1635433305614819","_HOSTNAME":"Z97X-UD5H","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_CMDLINE":"restic check","MESSAGE":"create exclusive lock for repository","__MONOTONIC_TIMESTAMP":"316999207285","_SYSTEMD_SLICE":"system.slice","_SYSTEMD_UNIT":"restic-backup.service","_EXE":"/usr/bin/restic","_SELINUX_CONTEXT":"unconfined\n","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_PID":"949065","_GID":"0","SYSLOG_FACILITY":"3","_TRANSPORT":"stdout"}
	{"_CMDLINE":"restic check","__REALTIME_TIMESTAMP":"1635433305867450","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_COMM":"restic","_TRANSPORT":"stdout","_GID":"0","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_EXE":"/usr/bin/restic","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc6;b=9d572844f08843b2988fe83d5dfea7ec;m=49cea3e44d;t=5cf6afd4004ba;x=277251f36f8f926b","_SYSTEMD_UNIT":"restic-backup.service","PRIORITY":"6","SYSLOG_FACILITY":"3","_HOSTNAME":"Z97X-UD5H","_SYSTEMD_SLICE":"system.slice","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","__MONOTONIC_TIMESTAMP":"316999459917","SYSLOG_IDENTIFIER":"restic-backup.sh","_CAP_EFFECTIVE":"3bfffeffff","_UID":"0","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","MESSAGE":"load indexes","_PID":"949065","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SELINUX_CONTEXT":"unconfined\n"}
	{"_SYSTEMD_UNIT":"restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc7;b=9d572844f08843b2988fe83d5dfea7ec;m=49cea9bdda;t=5cf6afd45de48;x=e592f73b133db5bc","MESSAGE":"check all packs","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_UID":"0","SYSLOG_FACILITY":"3","PRIORITY":"6","_CMDLINE":"restic check","__REALTIME_TIMESTAMP":"1635433306250824","_TRANSPORT":"stdout","_GID":"0","_SYSTEMD_SLICE":"system.slice","_PID":"949065","_EXE":"/usr/bin/restic","SYSLOG_IDENTIFIER":"restic-backup.sh","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_CAP_EFFECTIVE":"3bfffeffff","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","__MONOTONIC_TIMESTAMP":"316999843290","_HOSTNAME":"Z97X-UD5H","_COMM":"restic","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SELINUX_CONTEXT":"unconfined\n"}
	{"_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_UID":"0","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_PID":"949065","_CMDLINE":"restic check","_SYSTEMD_UNIT":"restic-backup.service","_SELINUX_CONTEXT":"unconfined\n","SYSLOG_IDENTIFIER":"restic-backup.sh","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_GID":"0","MESSAGE":"check snapshots, trees and blobs","_SYSTEMD_SLICE":"system.slice","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_EXE":"/usr/bin/restic","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_CAP_EFFECTIVE":"3bfffeffff","_COMM":"restic","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc8;b=9d572844f08843b2988fe83d5dfea7ec;m=49ceaa5424;t=5cf6afd467491;x=e0a9b5f5e88a6284","__MONOTONIC_TIMESTAMP":"316999881764","PRIORITY":"6","_TRANSPORT":"stdout","__REALTIME_TIMESTAMP":"1635433306289297","_HOSTNAME":"Z97X-UD5H","SYSLOG_FACILITY":"3"}
	{"_EXE":"/usr/bin/restic","__REALTIME_TIMESTAMP":"1635433307394475","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","SYSLOG_IDENTIFIER":"restic-backup.sh","_SYSTEMD_UNIT":"restic-backup.service","PRIORITY":"6","MESSAGE":"[0:01] 100.00%  29 / 29 snapshots","SYSLOG_FACILITY":"3","_UID":"0","_SELINUX_CONTEXT":"unconfined\n","_CMDLINE":"restic check","_TRANSPORT":"stdout","_CAP_EFFECTIVE":"3bfffeffff","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_PID":"949065","_GID":"0","_COMM":"restic","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dc9;b=9d572844f08843b2988fe83d5dfea7ec;m=49cebb313e;t=5cf6afd5751ab;x=36dbf6a2576c8984","_HOSTNAME":"Z97X-UD5H","__MONOTONIC_TIMESTAMP":"317000986942","_SYSTEMD_SLICE":"system.slice"}
	{"_UID":"0","SYSLOG_FACILITY":"3","_SYSTEMD_UNIT":"restic-backup.service","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_PID":"949065","__MONOTONIC_TIMESTAMP":"317000986942","_TRANSPORT":"stdout","SYSLOG_IDENTIFIER":"restic-backup.sh","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_COMM":"restic","__REALTIME_TIMESTAMP":"1635433307394475","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff","_HOSTNAME":"Z97X-UD5H","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dca;b=9d572844f08843b2988fe83d5dfea7ec;m=49cebb313e;t=5cf6afd5751ab;x=5532a286c12df433","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_GID":"0","_SELINUX_CONTEXT":"unconfined\n","_EXE":"/usr/bin/restic","_CMDLINE":"restic check","MESSAGE":"no errors were found","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_SYSTEMD_SLICE":"system.slice"}
	{"__REALTIME_TIMESTAMP":"1635433308426095","_PID":"949081","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SYSTEMD_UNIT":"restic-backup.service","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_COMM":"restic","_EXE":"/usr/bin/restic","_UID":"0","_CMDLINE":"restic backup --one-file-system --exclude-caches --files-from /etc/restic/includes --exclude-file /etc/restic/excludes --tag automated --json","PRIORITY":"6","_SELINUX_CONTEXT":"unconfined\n","_GID":"0","__MONOTONIC_TIMESTAMP":"317002018562","_CAP_EFFECTIVE":"3bfffeffff","MESSAGE":"{\"message_type\":\"status\",\"percent_done\":0}","_SYSTEMD_SLICE":"system.slice","_TRANSPORT":"stdout","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dcb;b=9d572844f08843b2988fe83d5dfea7ec;m=49cecaef02;t=5cf6afd670f6f;x=c76793b1c9f0d059","SYSLOG_IDENTIFIER":"restic-backup.sh","SYSLOG_FACILITY":"3","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_HOSTNAME":"Z97X-UD5H"}
	{"_PID":"949081","SYSLOG_FACILITY":"3","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_UID":"0","__MONOTONIC_TIMESTAMP":"317007671354","_CAP_EFFECTIVE":"3bfffeffff","_CMDLINE":"restic backup --one-file-system --exclude-caches --files-from /etc/restic/includes --exclude-file /etc/restic/excludes --tag automated --json","_SELINUX_CONTEXT":"unconfined\n","SYSLOG_IDENTIFIER":"restic-backup.sh","PRIORITY":"6","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dcc;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf21303a;t=5cf6afdbd50a7;x=eedf9ca5ca7e8af","_HOSTNAME":"Z97X-UD5H","__REALTIME_TIMESTAMP":"1635433314078887","_SYSTEMD_SLICE":"system.slice","_SYSTEMD_UNIT":"restic-backup.service","_EXE":"/usr/bin/restic","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_TRANSPORT":"stdout","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_GID":"0","_COMM":"restic","MESSAGE":"{\"message_type\":\"summary\",\"files_new\":0,\"files_changed\":4,\"files_unmodified\":68730,\"dirs_new\":0,\"dirs_changed\":6,\"dirs_unmodified\":18316,\"data_blobs\":3,\"tree_blobs\":7,\"data_added\":2812700,\"total_files_processed\":68734,\"total_bytes_processed\":2773758946,\"total_duration\":6.080174838,\"snapshot_id\":\"7eb911cb\"}"}
	{"PRIORITY":"6","_UID":"0","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_STREAM_ID":"4d0904c650614307b2b9da468347d8b1","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","MESSAGE":"Finished restic backup","__MONOTONIC_TIMESTAMP":"317007686586","_GID":"0","_COMM":"restic-backup.s","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_SYSTEMD_UNIT":"restic-backup.service","_EXE":"/usr/bin/bash","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dcd;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf216bba;t=5cf6afdbd8c28;x=f1c1a79236cea0f","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_CAP_EFFECTIVE":"3bfffeffff","_TRANSPORT":"stdout","SYSLOG_IDENTIFIER":"restic-backup.sh","__REALTIME_TIMESTAMP":"1635433314094120","_HOSTNAME":"Z97X-UD5H","_CMDLINE":"/bin/bash /usr/local/sbin/restic-backup.sh","_SYSTEMD_SLICE":"system.slice","_PID":"949064","_SELINUX_CONTEXT":"unconfined\n","SYSLOG_FACILITY":"3"}
	{"_GID":"0","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","__REALTIME_TIMESTAMP":"1635433314606399","_TRANSPORT":"stdout","SYSLOG_IDENTIFIER":"restic-export.sh","MESSAGE":"  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current","_EXE":"/usr/bin/curl","_UID":"0","_COMM":"curl","_SELINUX_CONTEXT":"unconfined\n","_STREAM_ID":"79bd57dd9f2c43249ce6eaa93ab43320","_PID":"949243","_SYSTEMD_SLICE":"system.slice","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_UNIT":"restic-backup.service","SYSLOG_FACILITY":"3","_CMDLINE":"curl -i -XPOST http://localhost:8086/api/v2/write --data-binary restic_backup,machine_id=\"f4995a7ba0ad462a999441ac1c4dde5e\",syslog_id=\"restic-backup.sh\" invocation_id=\"4775db08699a457696d94410100482bc\",files_new=0,files_changed=4,files_unmodified=68730,dirs_new=0,dirs_changed=6,dirs_unmodified=18316,total_files_processed=68734,total_bytes_processed=2773758946,total_duration=6.080174838,snapshot_id=\"7eb911cb\",systemd_unit=\"restic-backup.service\",monotonic_timestamp=\"317007671354\" 1635433314000000000","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_HOSTNAME":"Z97X-UD5H","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dce;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf293cd1;t=5cf6afdc55d3f;x=e7551a0a7a09c0b1","__MONOTONIC_TIMESTAMP":"317008198865"}
	{"_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_HOSTNAME":"Z97X-UD5H","MESSAGE":"                                 Dload  Upload   Total   Spent    Left  Speed","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dcf;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf293e98;t=5cf6afdc55f06;x=245f5132bc279fe3","__MONOTONIC_TIMESTAMP":"317008199320","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_CMDLINE":"curl -i -XPOST http://localhost:8086/api/v2/write --data-binary restic_backup,machine_id=\"f4995a7ba0ad462a999441ac1c4dde5e\",syslog_id=\"restic-backup.sh\" invocation_id=\"4775db08699a457696d94410100482bc\",files_new=0,files_changed=4,files_unmodified=68730,dirs_new=0,dirs_changed=6,dirs_unmodified=18316,total_files_processed=68734,total_bytes_processed=2773758946,total_duration=6.080174838,snapshot_id=\"7eb911cb\",systemd_unit=\"restic-backup.service\",monotonic_timestamp=\"317007671354\" 1635433314000000000","SYSLOG_FACILITY":"3","_SELINUX_CONTEXT":"unconfined\n","_EXE":"/usr/bin/curl","_GID":"0","_PID":"949243","SYSLOG_IDENTIFIER":"restic-export.sh","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_UNIT":"restic-backup.service","__REALTIME_TIMESTAMP":"1635433314606854","_STREAM_ID":"79bd57dd9f2c43249ce6eaa93ab43320","_SYSTEMD_SLICE":"system.slice","_COMM":"curl","_UID":"0","_TRANSPORT":"stdout"}
	{"MESSAGE":[13,32,32,48,32,32,32,32,32,48,32,32,32,32,48,32,32,32,32,32,48,32,32,32,32,48,32,32,32,32,32,48,32,32,32,32,32,32,48,32,32,32,32,32,32,48,32,45,45,58,45,45,58,45,45,32,45,45,58,45,45,58,45,45,32,45,45,58,45,45,58,45,45,32,32,32,32,32,48,13,49,48,48,32,32,32,52,51,57,32,32,32,32,48,32,32,32,32,32,48,32,32,49,48,48,32,32,32,52,51,57,32,32,32,32,32,32,48,32,32,32,52,50,56,107,32,45,45,58,45,45,58,45,45,32,45,45,58,45,45,58,45,45,32,45,45,58,45,45,58,45,45,32,32,52,50,56,107],"_PID":"949243","_STREAM_ID":"79bd57dd9f2c43249ce6eaa93ab43320","_COMM":"curl","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_GID":"0","_SYSTEMD_UNIT":"restic-backup.service","_UID":"0","_EXE":"/usr/bin/curl","_HOSTNAME":"Z97X-UD5H","_SELINUX_CONTEXT":"unconfined\n","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dd0;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf293f82;t=5cf6afdc55ff0;x=6fd63fc37e7c9e0c","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_CMDLINE":"curl -i -XPOST http://localhost:8086/api/v2/write --data-binary restic_backup,machine_id=\"f4995a7ba0ad462a999441ac1c4dde5e\",syslog_id=\"restic-backup.sh\" invocation_id=\"4775db08699a457696d94410100482bc\",files_new=0,files_changed=4,files_unmodified=68730,dirs_new=0,dirs_changed=6,dirs_unmodified=18316,total_files_processed=68734,total_bytes_processed=2773758946,total_duration=6.080174838,snapshot_id=\"7eb911cb\",systemd_unit=\"restic-backup.service\",monotonic_timestamp=\"317007671354\" 1635433314000000000","PRIORITY":"6","_TRANSPORT":"stdout","__MONOTONIC_TIMESTAMP":"317008199554","_SYSTEMD_SLICE":"system.slice","_CAP_EFFECTIVE":"3bfffeffff","__REALTIME_TIMESTAMP":"1635433314607088","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","SYSLOG_IDENTIFIER":"restic-export.sh","SYSLOG_FACILITY":"3"}
	{"_TRANSPORT":"stdout","__MONOTONIC_TIMESTAMP":"317008199628","_CMDLINE":"curl -i -XPOST http://localhost:8086/api/v2/write --data-binary restic_backup,machine_id=\"f4995a7ba0ad462a999441ac1c4dde5e\",syslog_id=\"restic-backup.sh\" invocation_id=\"4775db08699a457696d94410100482bc\",files_new=0,files_changed=4,files_unmodified=68730,dirs_new=0,dirs_changed=6,dirs_unmodified=18316,total_files_processed=68734,total_bytes_processed=2773758946,total_duration=6.080174838,snapshot_id=\"7eb911cb\",systemd_unit=\"restic-backup.service\",monotonic_timestamp=\"317007671354\" 1635433314000000000","_HOSTNAME":"Z97X-UD5H","MESSAGE":"HTTP/1.1 204 No Content","_STREAM_ID":"79bd57dd9f2c43249ce6eaa93ab43320","_PID":"949243","SYSLOG_IDENTIFIER":"restic-export.sh","_SYSTEMD_UNIT":"restic-backup.service","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_SYSTEMD_SLICE":"system.slice","SYSLOG_FACILITY":"3","_COMM":"curl","_EXE":"/usr/bin/curl","_GID":"0","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dd1;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf293fcc;t=5cf6afdc5603a;x=d73f43f1e0dd74cf","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","__REALTIME_TIMESTAMP":"1635433314607162","_SELINUX_CONTEXT":"unconfined\n","PRIORITY":"6","_CAP_EFFECTIVE":"3bfffeffff","_UID":"0"}
	{"PRIORITY":"6","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e","_HOSTNAME":"Z97X-UD5H","_SYSTEMD_UNIT":"restic-backup.service","SYSLOG_IDENTIFIER":"restic-export.sh","_COMM":"curl","__MONOTONIC_TIMESTAMP":"317008199628","__REALTIME_TIMESTAMP":"1635433314607162","_CAP_EFFECTIVE":"3bfffeffff","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","MESSAGE":"Date: Thu, 28 Oct 2021 15:01:54 GMT","_TRANSPORT":"stdout","_GID":"0","_PID":"949243","SYSLOG_FACILITY":"3","_CMDLINE":"curl -i -XPOST http://localhost:8086/api/v2/write --data-binary restic_backup,machine_id=\"f4995a7ba0ad462a999441ac1c4dde5e\",syslog_id=\"restic-backup.sh\" invocation_id=\"4775db08699a457696d94410100482bc\",files_new=0,files_changed=4,files_unmodified=68730,dirs_new=0,dirs_changed=6,dirs_unmodified=18316,total_files_processed=68734,total_bytes_processed=2773758946,total_duration=6.080174838,snapshot_id=\"7eb911cb\",systemd_unit=\"restic-backup.service\",monotonic_timestamp=\"317007671354\" 1635433314000000000","_EXE":"/usr/bin/curl","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_UID":"0","_SYSTEMD_SLICE":"system.slice","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dd2;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf293fcc;t=5cf6afdc5603a;x=c102ec9e0a704cb3","_STREAM_ID":"79bd57dd9f2c43249ce6eaa93ab43320","_SELINUX_CONTEXT":"unconfined\n","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec"}
	{"_TRANSPORT":"stdout","PRIORITY":"6","_PID":"949243","__CURSOR":"s=758865288d214086be7ab7f33762d9ec;i=4dd3;b=9d572844f08843b2988fe83d5dfea7ec;m=49cf293fcc;t=5cf6afdc5603a;x=c7adb291cd915c6b","SYSLOG_FACILITY":"3","_SYSTEMD_INVOCATION_ID":"4775db08699a457696d94410100482bc","_HOSTNAME":"Z97X-UD5H","SYSLOG_IDENTIFIER":"restic-export.sh","MESSAGE":[13],"_EXE":"/usr/bin/curl","__REALTIME_TIMESTAMP":"1635433314607162","_GID":"0","_UID":"0","_SELINUX_CONTEXT":"unconfined\n","_BOOT_ID":"9d572844f08843b2988fe83d5dfea7ec","_CMDLINE":"curl -i -XPOST http://localhost:8086/api/v2/write --data-binary restic_backup,machine_id=\"f4995a7ba0ad462a999441ac1c4dde5e\",syslog_id=\"restic-backup.sh\" invocation_id=\"4775db08699a457696d94410100482bc\",files_new=0,files_changed=4,files_unmodified=68730,dirs_new=0,dirs_changed=6,dirs_unmodified=18316,total_files_processed=68734,total_bytes_processed=2773758946,total_duration=6.080174838,snapshot_id=\"7eb911cb\",systemd_unit=\"restic-backup.service\",monotonic_timestamp=\"317007671354\" 1635433314000000000","_SYSTEMD_SLICE":"system.slice","_CAP_EFFECTIVE":"3bfffeffff","_STREAM_ID":"79bd57dd9f2c43249ce6eaa93ab43320","__MONOTONIC_TIMESTAMP":"317008199628","_SYSTEMD_UNIT":"restic-backup.service","_SYSTEMD_CGROUP":"/system.slice/restic-backup.service","_COMM":"curl","_MACHINE_ID":"f4995a7ba0ad462a999441ac1c4dde5e"}`
)

var (
	invocationIdCmd = []string{"/usr/bin/systemctl", "show", "-p", "InvocationID", "--value", testUnitName}
	logsCmd         = []string{"/usr/bin/journalctl", "-o", "short-iso",
		fmt.Sprintf("_SYSTEMD_INVOCATION_ID=%s", invocationIdOut), "--output", "json"}
)

func TestHelperProcess(t *testing.T) {
	testutils.RunTestExecCmd()
}

func TestSystemd(t *testing.T) {
	tests := []struct {
		name        string
		execResults []testutils.ExecCmdTestResult
		want        *cmd.SyslogEntry
		wantError   bool
	}{
		{
			name: "Success",
			execResults: []testutils.ExecCmdTestResult{
				testutils.MakeResult(invocationIdOut, "", 0, invocationIdCmd...),
				testutils.MakeResult(journalLogsOut, "", 0, logsCmd...),
			},
			want: &cmd.SyslogEntry{
				SyslogId:           "restic-backup.sh",
				MonotonicTimestamp: 317007671354,
				InvocationId:       invocationIdOut,
				SystemdUnit:        testUnitName,
				MachineId:          "f4995a7ba0ad462a999441ac1c4dde5e",
				Hostname:           "Z97X-UD5H",
				Message: cmd.MessageWrapper{
					ResticMessage: &cmd.ResticMsg{
						MessageType:         "summary",
						FilesNew:            0,
						FilesChanged:        4,
						FilesUnmodified:     68730,
						DirsNew:             0,
						DirsChanged:         6,
						DirsUnmodified:      18316,
						TotalFilesProcessed: 68734,
						TotalBytesProcessed: 2773758946,
						TotalDuration:       6.08,
						SnapshotId:          "7eb911cb",
					},
				},
			},
		},
	}

	// Approximate equality for floats
	opt := cmp.Comparer(func(x, y float64) bool {
		delta := math.Abs(x - y)
		mean := math.Abs(x+y) / 2.0
		return delta/mean < 0.01
	})

	for _, test := range tests {
		t.Run(test.name, func(t *testing.T) {
			execTestHelper := testutils.NewExecCmdTestHelper("TestHelperProcess")
			execCommand := execTestHelper.ExecCommand
			defer func() { execCommand = exec.Command }()

			for _, er := range test.execResults {
				execTestHelper.AddExecResult(er)
			}

			s := cmd.NewSystemd(execCommand, false, testUnitName)
			entry, err := s.GetResticSummary()
			if test.wantError {
				if err == nil {
					t.Errorf("GetResticSummary error mismatch. Got %v, Wanted: %v", err, test.wantError)
				}
				return
			}
			if test.wantError != (err != nil) {
				t.Errorf("GetResticSummary error mismatch. Got %v, Wanted: %v", err, test.wantError)
			}
			if entry == nil {
				t.Errorf("GetResticSummary unexpectedly nil")
			}

			if diff := cmp.Diff(test.want, entry, opt); diff != "" {
				t.Errorf("GetResticSummary unexpected difff (-want, +got): %v", diff)
			}
		})
	}
}
